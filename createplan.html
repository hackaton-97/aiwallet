<!DOCTYPE html>
<html class="dark" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>AI Wallet | Create Plan</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300..700&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
<style>
        .glow-border {
            box-shadow: 0 0 2px #A7C69F, 0 0 5px #A7C69F, 0 0 10px #A7C69F;
        }
        .glow-button {
            box-shadow: 0 0 5px #A7C69F, 0 0 10px #A7C69F, 0 0 15px #A7C69F;
        }
        .glow-text {
            text-shadow: 0 0 5px #A7C69F;
        }
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        body {
            font-family: 'Space Grotesk', sans-serif;
            background-image:
                radial-gradient(circle at 10% 20%, rgba(167, 198, 159, 0.1) 0%, transparent 25%),
                radial-gradient(circle at 90% 80%, rgba(167, 198, 159, 0.1) 0%, transparent 25%);
            background-attachment: fixed;
        }
        /* Light mode styles */
        html:not(.dark) { 
            background-color: #ffffff !important;
            color: #1a1a1a;
        }
        html:not(.dark) body { 
            background-color: #ffffff !important;
            color: #1a1a1a;
        }
        html:not(.dark) [class*="text-white"] {
            color: #1a1a1a !important;
        }
        html:not(.dark) [class*="text-white/"] {
            color: rgba(26, 26, 26, 0.8) !important;
        }
        html:not(.dark) [class*="bg-black"] {
            background-color: #ffffff !important;
        }
        html:not(.dark) [class*="bg-black/"] {
            background-color: rgba(255, 255, 255, 0.95) !important;
        }
        html:not(.dark) [class*="bg-custom-bg"],
        html:not(.dark) [class*="bg-[#333333]"],
        html:not(.dark) [class*="bg-[#0a0a0a]"] {
            background-color: #f5f5f5 !important;
        }
        html:not(.dark) [class*="border-"] {
            border-color: #e0e0e0 !important;
        }
        html:not(.dark) [class*="text-[#A7C69F]"],
        html:not(.dark) [class*="text-custom-accent"] {
            color: #5a7a4f !important;
        }
        html:not(.dark) svg {
            color: inherit !important;
        }
        html:not(.dark) a[href="index.html"] svg {
            color: #5a7a4f !important;
        }
        html:not(.dark) #profileModal {
            background-color: transparent !important;
        }
        html:not(.dark) #profileModal > div {
            background-color: #ffffff !important;
            border-color: #5a7a4f !important;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1) !important;
        }
        html:not(.dark) #profileModal button,
        html:not(.dark) #profileModal a {
            color: #1a1a1a !important;
        }
        html:not(.dark) #profileModal button:last-child {
            color: #ef4444 !important;
        }
        html:not(.dark) #profileModal button:hover,
        html:not(.dark) #profileModal a:hover {
            background-color: #f0f0f0 !important;
        }
        html:not(.dark) #profileAvatar {
            border-color: #5a7a4f !important;
        }
        html:not(.dark) .bg-black\/20 {
            background-color: rgba(245, 245, 245, 0.8) !important;
        }
        html:not(.dark) .border-white\/20 {
            border-color: #e0e0e0 !important;
        }
        html:not(.dark) .bg-black\/30 {
            background-color: rgba(255, 255, 255, 0.8) !important;
            border-color: #e0e0e0 !important;
        }
        html:not(.dark) .bg-black\/20 {
            background-color: rgba(255, 255, 255, 0.6) !important;
            border-color: #e0e0e0 !important;
        }
        html:not(.dark) input[type="number"],
        html:not(.dark) input[type="text"] {
            background-color: #f5f5f5 !important;
            border-color: #d0d0d0 !important;
            color: #1a1a1a !important;
        }
        html:not(.dark) input[type="number"]::placeholder,
        html:not(.dark) input[type="text"]::placeholder {
            color: #999 !important;
        }
        html:not(.dark) input[type="number"]:focus,
        html:not(.dark) input[type="text"]:focus {
            background-color: #ffffff !important;
            border-color: #5a7a4f !important;
            color: #1a1a1a !important;
        }
        html:not(.dark) input[type="number"]::-webkit-inner-spin-button,
        html:not(.dark) input[type="number"]::-webkit-outer-spin-button {
            opacity: 1;
        }
        html:not(.dark) .bg-\[#232323\] {
            background-color: #f5f5f5 !important;
        }
        html:not(.dark) textarea {
            background-color: #f5f5f5 !important;
            color: #1a1a1a !important;
            border-color: rgba(90, 122, 79, 0.3) !important;
        }
        html:not(.dark) textarea::placeholder {
            color: #999 !important;
        }
        html:not(.dark) textarea:focus {
            background-color: #ffffff !important;
            border-color: #5a7a4f !important;
        }
        html:not(.dark) .success-content {
            background-color: #ffffff;
            border-color: #5a7a4f;
        }
        html:not(.dark) .success-content h2 {
            color: #5a7a4f !important;
        }
        html:not(.dark) .success-content p {
            color: #1a1a1a !important;
        }
        html:not(.dark) #aiModal button {
            color: #1a1a1a !important;
        }
        html:not(.dark) #aiCancelBtn {
            border-color: #5a7a4f !important;
            color: #5a7a4f !important;
        }
        html:not(.dark) #aiSubmitBtn {
            background-color: #5a7a4f !important;
            color: #ffffff !important;
        }
        html:not(.dark) #aiSubmitBtn:hover {
            background-color: #4a6a3f !important;
        }
        html:not(.dark) #aiError {
            color: #dc2626 !important;
        }
        html:not(.dark) #aiLoading {
            color: #1a1a1a !important;
        }
        .success-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .success-modal.show {
            display: flex;
        }
        .success-content {
            background-color: #181818;
            border: 1px solid #A7C69F;
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            min-width: 300px;
        }
        html:not(.dark) .success-content {
            background-color: #ffffff;
            border-color: #5a7a4f;
        }
        .success-icon {
            font-size: 64px;
            color: #A7C69F;
            margin-bottom: 20px;
        }
        html:not(.dark) .success-icon {
            color: #5a7a4f;
        }
    </style>
    <style>
    </style>
<script src="db-manager.js" defer></script>
<script src="script.js" defer></script>
</head>
<body class="font-display" style="background-color: #000000;">
<!-- Ð Ð£Ð¡Ð¡ÐšÐ˜Ð™ ÐšÐžÐœÐœÐ•ÐÐ¢ÐÐ Ð˜Ð™: Ð“Ð»Ð°Ð²Ð½Ñ‹Ð¹ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ñ„Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ñ‹Ñ… Ð¿Ð»Ð°Ð½Ð¾Ð² -->
<div class="relative flex h-auto min-h-screen w-full flex-col overflow-x-hidden text-white" style="background-image: linear-gradient(rgba(0, 0, 0, 0.95), rgba(0, 0, 0, 0.95)), url('https://lh3.googleusercontent.com/aida-public/AB6AXuCpFh7OSUzEj0XKLJfBIIV04v-GovLLGjGnzDoQbT0ps0Df9oU8HHpWzi4FU3EgN14NBNziFl4HZcvrKRIUfrB1wovmysIFaTBEbmc8R-7C8ndna4mgfw2eBXQcnnGJmYoAv3r98aJO0Nn8M4fCw14NBF3PWea5A4IR7yc2kkzNdVtZh8_iOgzDSH1Tvn6i9pRDZszXGg4L7kGCz_NRI0F8qoAkp4S5JrV2-3XpTR15xeC-kj1YhQ82SbMUKY4K9_ngc4YGUunxrFQL'); background-size: cover; background-attachment: fixed;">
<div class="layout-container flex h-full grow flex-col">
<div class="flex flex-1 justify-center py-5">
<div class="layout-content-container flex flex-col w-full max-w-[1100px] flex-1 px-4 sm:px-10">
<header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-custom-accent/20 px-4 py-3 backdrop-blur-sm bg-custom-bg/30 rounded-t-lg">
<a href="index.html" class="flex items-center gap-4 text-custom-accent cursor-pointer hover:opacity-80 transition-opacity">
<div class="size-4 text-glow">
<svg fill="none" viewbox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
<path clip-rule="evenodd" d="M24 4H6V17.3333V30.6667H24V44H42V30.6667V17.3333H24V4Z" fill="currentColor" fill-rule="evenodd"></path>
</svg>
</div>
<h2 class="text-custom-accent text-lg font-bold leading-tight tracking-[-0.015em] text-glow">AIWallet</h2>
</a>
<div class="flex flex-1 justify-end gap-8">
    <div class="flex items-center gap-9">
      <a id="addPurchaseLink" class="hidden text-white/80 text-sm font-medium leading-normal transition-colors hover:text-[#A7C69F] hover:drop-shadow-[0_0_8px_#A7C69F]" href="addpurchase.html">Add Purchase</a>
      <a id="createPlanLink" class="hidden text-white/80 text-sm font-medium leading-normal transition-colors hover:text-[#A7C69F] hover:drop-shadow-[0_0_8px_#A7C69F]" href="createplan.html">Create Plan</a>
    <a id="myPlansLink" class="hidden text-white/80 text-sm font-medium leading-normal transition-colors hover:text-[#A7C69F] hover:drop-shadow-[0_0_8px_#A7C69F]" href="myplans.html">My Plans</a>
    <a id="sharePlanLink" class="hidden text-white/80 text-sm font-medium leading-normal transition-colors hover:text-[#A7C69F] hover:drop-shadow-[0_0_8px_#A7C69F]" href="share-plans.html">Share Plan</a>
    <a id="dashboardLink" class="hidden text-white/80 text-sm font-medium leading-normal transition-colors hover:text-[#A7C69F] hover:drop-shadow-[0_0_8px_#A7C69F]" href="profile.html">Dashboard</a>
    <a class="text-white/80 text-sm font-medium leading-normal transition-colors hover:text-[#A7C69F] hover:drop-shadow-[0_0_8px_#A7C69F]" href="pricing.html">Pricing</a>
  </div>
  <div class="flex gap-2">
    <button id="themeToggle" class="flex min-w-[40px] w-10 h-10 cursor-pointer items-center justify-center overflow-hidden rounded-lg bg-transparent border border-[#A7C69F]/50 text-custom-accent font-bold transition-all hover:bg-[#A7C69F]/10 hover:border-[#A7C69F] hover:shadow-[0_0_8px_#A7C69F_inset]" title="Toggle theme">
      <span id="themeIcon">ðŸŒ™</span>
    </button>
    <div id="authButtons" class="flex gap-2">
      <a id="getStartedBtn" href="signup.html" class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-[#A7C69F] text-[#333333] text-sm font-bold leading-normal tracking-[0.015em] transition-all hover:bg-white hover:shadow-[0_0_15px_#A7C69F] border border-[#A7C69F]">
        <span class="truncate">Get Started</span>
      </a>
      <a href="signin.html" class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-transparent border border-[#A7C69F]/50 text-white text-sm font-bold leading-normal tracking-[0.015em] transition-all hover:bg-[#A7C69F]/10 hover:border-[#A7C69F] hover:shadow-[0_0_8px_#A7C69F_inset]">
        <span class="truncate">Login</span>
      </a>
    </div>
    <div id="profileAvatar" class="hidden flex items-center justify-center w-10 h-10 rounded-lg bg-[#A7C69F] text-[#333333] font-bold text-lg cursor-pointer hover:shadow-[0_0_15px_#A7C69F] transition-all border border-[#A7C69F]" title="Profile" onclick="toggleProfileMenu()">
      <span id="avatarInitial">U</span>
    </div>
  </div>
</div>
</header>

<!-- Profile Menu Modal -->
<div id="profileModal" class="hidden fixed inset-0 z-50 flex items-start justify-end pt-20 pr-10" onclick="closeProfileMenuOnBackdrop(event)">
  <div class="bg-black/90 border border-[#A7C69F]/30 rounded-lg shadow-lg min-w-[220px] w-[250px] max-w-xs backdrop-blur-sm" onclick="event.stopPropagation()">
    <div class="p-4 space-y-3">
      <div class="text-white text-sm px-4 py-2 border-b border-[#A7C69F]/20">
        <p class="font-semibold"><span id="profileUsername">User</span></p>
        <p class="text-xs text-gray-400"><span id="profileEmail">email@example.com</span></p>
      </div>
      <button type="button" id="infoDropdownButton" class="w-full text-left px-4 py-2 text-white flex items-center gap-2 hover:bg-[#A7C69F]/10 transition-colors rounded justify-between">
        <span class="flex items-center gap-2"><span class="material-symbols-outlined" style="font-size: 20px; display: inline-flex;">info</span>Info</span>
        <span class="material-symbols-outlined transition-transform" id="infoDropdownArrow" style="font-size:19px;">expand_more</span>
      </button>
      <div id="infoDropdownMenu" class="hidden flex flex-col gap-1 mb-1 px-2 pt-1 ">
          <a href="overview.html" class="w-full text-left px-4 py-2 text-white hover:bg-[#A7C69F]/10 transition-colors rounded flex items-center gap-2"><span class="material-symbols-outlined" style="font-size:18px;">subject</span>Overview</a>
          <a href="features.html" class="w-full text-left px-4 py-2 text-white hover:bg-[#A7C69F]/10 transition-colors rounded flex items-center gap-2"><span class="material-symbols-outlined" style="font-size:18px;">star</span>Features</a>
          <a href="resources.html" class="w-full text-left px-4 py-2 text-white hover:bg-[#A7C69F]/10 transition-colors rounded flex items-center gap-2"><span class="material-symbols-outlined" style="font-size:18px;">book</span>Resources</a>
      </div>
      <button onclick="handleLogout()" class="w-full text-left px-4 py-2 text-white hover:bg-[#A7C69F]/10 transition-colors rounded flex items-center gap-2"><span class="material-symbols-outlined" style="font-size: 20px; display: inline-flex;">logout</span> Logout</button>
      <button onclick="handleDeleteAccount()" class="w-full text-left px-4 py-2 text-red-500 hover:bg-red-500/10 transition-colors rounded flex items-center gap-2"><span class="material-symbols-outlined" style="font-size: 20px; display: inline-flex;">delete</span> Delete Account</button>
    </div>
  </div>
</div>

<div class="py-16 sm:py-24">
<div class="max-w-4xl mx-auto">
<div class="bg-black/20 border border-white/20 rounded-lg backdrop-blur-sm p-8">
<div class="flex items-center justify-between mb-8">
  <h1 class="text-3xl font-bold text-white glow-text">Create Financial Plan</h1>
  <button id="fillWithAiBtn" class="flex items-center gap-2 px-4 py-2 bg-[#A7C69F] text-[#333333] font-bold rounded-lg hover:bg-[#89b788] transition-colors glow-button">
    <span class="material-symbols-outlined" style="font-size: 20px;">smart_toy</span>
    Fill with AI
  </button>
</div>

<div class="space-y-6">
  <!-- Income Section -->
  <div class="bg-black/30 border border-white/10 rounded-lg p-6">
    <h2 class="text-xl font-bold text-white mb-4">Income</h2>
    <div class="space-y-4">
      <div>
        <label class="block text-white/80 text-sm font-medium mb-2">Salary ($)</label>
        <input type="number" id="salary_input" class="w-full rounded-lg bg-[#232323] dark:bg-[#232323] border border-[#A7C69F]/30 dark:border-[#A7C69F]/30 p-3 text-base text-white dark:text-white outline-none focus:border-[#A7C69F] transition-colors" placeholder="Enter your monthly salary" value="0" min="0">
      </div>
      <div>
        <label class="block text-white/80 text-sm font-medium mb-2">Debts ($)</label>
        <input type="number" id="debts_input" class="w-full rounded-lg bg-[#232323] dark:bg-[#232323] border border-[#A7C69F]/30 dark:border-[#A7C69F]/30 p-3 text-base text-white dark:text-white outline-none focus:border-[#A7C69F] transition-colors" placeholder="Enter your total debts" value="0" min="0">
      </div>
    </div>
  </div>

  <!-- Expenses Section -->
  <div class="bg-black/30 border border-white/10 rounded-lg p-6">
    <h2 class="text-xl font-bold text-white mb-4">Expenses</h2>
    <div class="space-y-4">
      <div class="flex gap-4">
        <div class="flex-1">
          <label class="block text-white/80 text-sm font-medium mb-2">Expense Name</label>
          <input type="text" id="expense_name_input" class="w-full rounded-lg bg-[#232323] border border-[#A7C69F]/30 p-3 text-base text-white outline-none focus:border-[#A7C69F] transition-colors" placeholder="e.g., Groceries">
        </div>
        <div class="flex-1">
          <label class="block text-white/80 text-sm font-medium mb-2">Amount ($)</label>
          <input type="number" id="expense_amount_input" class="w-full rounded-lg bg-[#232323] border border-[#A7C69F]/30 p-3 text-base text-white outline-none focus:border-[#A7C69F] transition-colors" placeholder="0" min="0" step="0.01">
        </div>
        <div class="flex items-end">
          <button id="add_expense_btn" class="px-6 py-3 rounded-lg bg-[#A7C69F] text-[#333333] font-bold hover:bg-[#89b788] transition-colors glow-button">Add</button>
        </div>
      </div>
      <div id="expenses_list" class="space-y-2 mt-4"></div>
    </div>
  </div>

  <!-- Results Section -->
  <div class="bg-black/30 border border-white/10 rounded-lg p-6">
    <h2 class="text-xl font-bold text-white mb-4">Financial Summary</h2>
    <div id="result_message" class="text-white/80 mb-4"></div>
    <div class="flex items-center gap-4">
      <span class="text-white/80">Daily Limit:</span>
      <span id="daily_limit" class="text-2xl font-bold text-[#A7C69F] glow-text">$0</span>
    </div>
  </div>

  <div class="flex justify-center">
    <button id="save_plan_btn" class="px-8 py-4 rounded-lg bg-[#A7C69F] text-[#333333] text-lg font-bold hover:bg-[#89b788] transition-colors glow-button">Save Plan</button>
  </div>
</div>
</div>
</div>
</div>

<footer class="flex flex-col items-center justify-between gap-6 border-t border-white/20 py-8 px-4 mt-8 text-center md:flex-row md:text-left">
<div class="flex items-center gap-3">
<div class="size-4">
<svg class="text-[#A7C69F]" fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
<path clip-rule="evenodd" d="M24 4H6V17.3333V30.6667H24V44H42V30.6667V17.3333H24V4Z" fill="currentColor" fill-rule="evenodd"></path>
</svg>
</div>
<p class="text-sm text-white/60">Â© 2024 AIWallet. All rights reserved.</p>
</div>
<div class="flex items-center gap-6">
<a class="text-sm text-white/60 hover:text-white transition-colors" href="#">Privacy Policy</a>
<a class="text-sm text-white/60 hover:text-white transition-colors" href="#">Terms of Service</a>
<a class="text-sm text-white/60 hover:text-white transition-colors" href="#">Contact</a>
</div>
</footer>
</div>
</div>
</div>
</div>

<!-- Success Modal -->
<div id="success_modal" class="success-modal">
  <div class="success-content">
    <div class="success-icon">âœ“</div>
    <h2 class="text-2xl font-bold text-white mb-2" style="color: #A7C69F;">Successfully added</h2>
    <p class="text-white/80">Your financial plan has been saved!</p>
    <p id="redirect_message" class="text-white/60 mt-4 text-sm">Redirecting in <span id="countdown">3</span> sec...</p>
  </div>
</div>

<!-- AI Fill Modal -->
<div id="aiModal" class="success-modal">
  <div class="success-content" style="min-width: 400px; max-width: 500px;">
    <h2 class="text-2xl font-bold text-white mb-4" style="color: #A7C69F;">Fill with AI</h2>
    <p class="text-white/80 mb-4">Describe your financial situation and let AI fill out your plan:</p>
    <textarea id="aiPrompt" class="w-full rounded-lg bg-[#232323] border border-[#A7C69F]/30 p-3 text-white outline-none focus:border-[#A7C69F] transition-colors" rows="6" placeholder="Example: My monthly salary is $3000, I have $5000 in debts, I spend $500 on groceries, $200 on utilities, $300 on rent, etc."></textarea>
    <div id="aiError" class="text-red-400 text-sm mt-2" style="display:none;"></div>
    <div id="aiLoading" style="display:none;" class="text-white/60 text-sm mt-2">Processing with AI...</div>
    <div class="flex gap-3 justify-end mt-4">
      <button id="aiCancelBtn" class="px-5 py-2 border border-[#A7C69F] text-[#A7C69F] rounded hover:bg-[#232323]/60 transition-colors">Cancel</button>
      <button id="aiSubmitBtn" class="px-5 py-2 bg-[#A7C69F] text-[#232323] font-bold rounded hover:bg-[#89b788] transition-colors">Process with AI</button>
    </div>
  </div>
</div>

<script>
// Load profile data on page load
window.addEventListener('load', function() {
  checkUserStatus();
});

const salaryInput = document.getElementById("salary_input");
const debtsInput = document.getElementById("debts_input");
const expenseNameInput = document.getElementById("expense_name_input");
const expenseAmountInput = document.getElementById("expense_amount_input");
const addExpenseBtn = document.getElementById("add_expense_btn");
const expensesList = document.getElementById("expenses_list");
const resultMessage = document.getElementById("result_message");
const dailyLimitSpan = document.getElementById("daily_limit");
const savePlanBtn = document.getElementById("save_plan_btn");
const successModal = document.getElementById("success_modal");

let expenses = [];

// Add Enter key handlers
function addEnterKeyHandlers() {
  const inputs = [salaryInput, debtsInput, expenseNameInput, expenseAmountInput];
  inputs.forEach(input => {
    if (input) {
      input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey && !e.ctrlKey && !e.altKey) {
          e.preventDefault();
          if (input === expenseNameInput || input === expenseAmountInput) {
            addExpenseBtn.click();
          }
        }
      });
    }
  });
}

// Add expense
addExpenseBtn.addEventListener("click", () => {
  const name = expenseNameInput.value.trim();
  const amount = Number(expenseAmountInput.value);

  if (!name || amount <= 0) {
    if (window.showCustomModal) {
      window.showCustomModal({
        type: 'confirm',
        title: 'Invalid Input',
        message: 'Please enter valid expense name and amount.',
        confirmText: 'OK',
        cancelText: '',
        onConfirm: function() {}
      });
    } else {
      alert("Please enter valid expense name and amount.");
    }
    return;
  }

  expenses.push({ name, amount });

  const div = document.createElement("div");
  div.className = "expense_item flex justify-between items-center p-3 bg-black/20 border border-white/10 rounded-lg";
  div.innerHTML = `
    <span class="text-white">${name}: $${amount}</span>
    <button class="text-red-400 hover:text-red-300 transition-colors" onclick="removeExpense(${expenses.length - 1})">
      <span class="material-symbols-outlined">delete</span>
    </button>
  `;
  expensesList.appendChild(div);

  expenseNameInput.value = "";
  expenseAmountInput.value = "";

  updateResult();
});

function removeExpense(index) {
  expenses.splice(index, 1);
  renderExpenses();
  updateResult();
}

function renderExpenses() {
  expensesList.innerHTML = "";
  expenses.forEach((expense, index) => {
    const div = document.createElement("div");
    div.className = "expense_item flex justify-between items-center p-3 bg-black/20 border border-white/10 rounded-lg";
    div.innerHTML = `
      <span class="text-white">${expense.name}: $${expense.amount}</span>
      <button class="text-red-400 hover:text-red-300 transition-colors" onclick="removeExpense(${index})">
        <span class="material-symbols-outlined">delete</span>
      </button>
    `;
    expensesList.appendChild(div);
  });
}

// Update result when salary or debts change
salaryInput.addEventListener("input", updateResult);
debtsInput.addEventListener("input", updateResult);

// Calculate and display result
function updateResult() {
  const salary = Number(salaryInput.value) || 0;
  const debts = Number(debtsInput.value) || 0;

  const totalExpenses = expenses.reduce((sum, e) => sum + e.amount, 0);
  const totalRequired = debts + totalExpenses;

  let moneyLeft = salary - totalRequired;

  if (moneyLeft < 0) moneyLeft = 0;

  resultMessage.innerHTML = `
    Salary: $${salary.toLocaleString()} <br>
    Debts: $${debts.toLocaleString()} <br>
    Expenses: $${totalExpenses.toLocaleString()} <br><br>
    <b>Remaining for month: $${moneyLeft.toLocaleString()}</b>
  `;

  const dailyLimit = Math.floor(moneyLeft / 30);
  dailyLimitSpan.innerText = "$" + dailyLimit.toLocaleString();
}

// Save plan
savePlanBtn.addEventListener("click", async () => {
  const salary = Number(salaryInput.value) || 0;
  const debts = Number(debtsInput.value) || 0;

  if (salary === 0 && expenses.length === 0) {
    if (window.showCustomModal) {
      window.showCustomModal({
        type: 'confirm',
        title: 'Invalid Plan',
        message: 'Please enter data to save the plan.',
        confirmText: 'OK',
        cancelText: '',
        onConfirm: function() {}
      });
    } else {
      alert("Please enter data to save the plan.");
    }
    return;
  }

  const userId = localStorage.getItem('userId');
  if (!userId) {
    if (window.showCustomModal) {
      window.showCustomModal({
        type: 'confirm',
        title: 'Not Logged In',
        message: 'Please log in to save your plan.',
        confirmText: 'OK',
        cancelText: '',
        onConfirm: function() {
          window.location.href = 'signin.html';
        }
      });
    } else {
      alert("Please log in to save your plan.");
    }
    return;
  }

  // Save to JSON file (simulated with localStorage for now, but structured for file-based storage)
  const planData = {
    id: Date.now().toString(),
    userId: userId,
    salary,
    debts,
    expenses,
    totalExpenses: expenses.reduce((sum, e) => sum + e.amount, 0),
    moneyLeft: Math.max(0, salary - debts - expenses.reduce((sum, e) => sum + e.amount, 0)),
    dailyLimit: Math.floor(Math.max(0, salary - debts - expenses.reduce((sum, e) => sum + e.amount, 0)) / 30),
    pinned: false,
    createdAt: new Date().toISOString()
  };

  // Load existing plans from localStorage (simulating JSON file)
  let allPlans = JSON.parse(localStorage.getItem('financial_plans_db') || '{}');
  if (!allPlans[userId]) {
    allPlans[userId] = [];
  }
  allPlans[userId].push(planData);
  localStorage.setItem('financial_plans_db', JSON.stringify(allPlans));
  
  // Also save to server (users.json)
  try {
    const response = await fetch(`/api/user/${userId}/plans`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(planData)
    });
    if (!response.ok) {
      console.warn('Failed to save plan to server');
    }
  } catch (error) {
    console.warn('Failed to save plan to server:', error);
  }

  // Show success modal with countdown
  successModal.classList.add('show');
  const redirectMessage = document.getElementById('redirect_message');
  const countdownSpan = document.getElementById('countdown');
  let countdown = 3;
  
  const countdownInterval = setInterval(() => {
    countdown--;
    if (countdownSpan) countdownSpan.textContent = countdown;
    if (countdown <= 0) {
      clearInterval(countdownInterval);
      successModal.classList.remove('show');
      window.location.href = 'myplans.html';
    }
  }, 1000);
});

// Initialize
addEnterKeyHandlers();
updateResult();

// ====== AI FILL FUNCTIONALITY ======
const API_KEY = "AIzaSyBazN2j3ijc14PgsUZcmo-i2bIQqwfheTM";
const MODEL_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent";

const aiModal = document.getElementById('aiModal');
const fillWithAiBtn = document.getElementById('fillWithAiBtn');
const aiPrompt = document.getElementById('aiPrompt');
const aiSubmitBtn = document.getElementById('aiSubmitBtn');
const aiCancelBtn = document.getElementById('aiCancelBtn');
const aiError = document.getElementById('aiError');
const aiLoading = document.getElementById('aiLoading');

// Open AI modal
fillWithAiBtn.addEventListener('click', () => {
  aiModal.classList.add('show');
  aiPrompt.focus();
  aiPrompt.value = '';
  aiError.style.display = 'none';
  aiLoading.style.display = 'none';
});

// Close AI modal
aiCancelBtn.addEventListener('click', () => {
  aiModal.classList.remove('show');
});

// Close modal on backdrop click
aiModal.addEventListener('click', (e) => {
  if (e.target === aiModal) {
    aiModal.classList.remove('show');
  }
});

// Process with AI
aiSubmitBtn.addEventListener('click', async () => {
  const prompt = aiPrompt.value.trim();
  if (!prompt) {
    aiError.textContent = 'Please describe your financial situation';
    aiError.style.display = 'block';
    return;
  }

  aiSubmitBtn.disabled = true;
  aiLoading.style.display = 'block';
  aiError.style.display = 'none';

  try {
    // Create a structured prompt for AI to extract financial data
    const systemPrompt = `You are a financial assistant. Extract financial information from the user's description and respond ONLY with valid JSON (no markdown, no code blocks, just pure JSON) in this exact format:
{
  "salary": 0,
  "debts": 0,
  "expenses": [
    {"name": "rent", "amount": 500},
    {"name": "groceries", "amount": 200}
  ]
}

All values must be numbers. If a value is not mentioned, use 0. Extract all mentioned expenses. Respond ONLY with the JSON object, nothing else.`;

    const userMessage = `Extract financial data from this description: "${prompt}"`;

    const payload = {
      contents: [
        {
          role: "user",
          parts: [
            { text: userMessage }
          ]
        }
      ],
      systemInstruction: {
        parts: [
          { text: systemPrompt }
        ]
      }
    };

    const resp = await fetch(MODEL_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "x-goog-api-key": API_KEY
      },
      body: JSON.stringify(payload)
    });

    if (!resp.ok) {
      throw new Error("Failed to call AI API: " + resp.statusText);
    }

    const data = await resp.json();
    const responseText = data?.candidates?.[0]?.content?.parts?.[0]?.text;

    if (!responseText) {
      throw new Error("No response from AI");
    }

    // Parse the JSON response
    let parsedData;
    try {
      // Try to extract JSON from the response (in case there's extra text)
      const jsonMatch = responseText.match(/\{[\s\S]*\}/);
      if (!jsonMatch) {
        throw new Error("No JSON found in response");
      }
      parsedData = JSON.parse(jsonMatch[0]);
    } catch (e) {
      console.error("Failed to parse AI response:", responseText);
      throw new Error("Invalid response from AI: " + String(e.message));
    }

    // Fill the form with extracted data
    if (parsedData.salary) {
      salaryInput.value = parsedData.salary;
    }
    if (parsedData.debts) {
      debtsInput.value = parsedData.debts;
    }

    // Clear existing expenses
    expenses = [];
    renderExpenses();

    // Add expenses from AI
    if (parsedData.expenses && Array.isArray(parsedData.expenses)) {
      parsedData.expenses.forEach(exp => {
        if (exp.name && exp.amount) {
          expenses.push({
            name: exp.name,
            amount: parseFloat(exp.amount) || 0
          });
        }
      });
      renderExpenses();
    }

    // Update results
    updateResult();

    // Close modal
    aiModal.classList.remove('show');

  } catch (err) {
    aiError.textContent = 'Error: ' + String(err.message);
    aiError.style.display = 'block';
    console.error("AI Error:", err);
  } finally {
    aiSubmitBtn.disabled = false;
    aiLoading.style.display = 'none';
  }
});
</script>
</body>
</html>

